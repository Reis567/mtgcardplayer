<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partida - MTG Commander</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a12;
            color: #eee;
            min-height: 100vh;
            overflow: hidden;
        }
        .game-container {
            display: grid;
            grid-template-rows: auto auto 1fr auto auto;
            height: 100vh;
            gap: 4px;
            padding: 4px;
        }

        /* ===== HEADER ===== */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .turn-info { display: flex; gap: 10px; align-items: center; font-size: 0.85rem; }
        .turn-info .turn { color: #e94560; font-weight: bold; }
        .turn-info .active { color: #ffc107; }
        .connection-status { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; }
        .connection-dot { width: 7px; height: 7px; border-radius: 50%; background: #c0392b; }
        .connection-dot.connected { background: #27ae60; }
        .game-controls button {
            padding: 4px 8px;
            margin-left: 5px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        .game-controls button:hover { background: rgba(255,255,255,0.2); }
        .game-controls button.primary { background: #e94560; }

        /* ===== PHASE TRACKER ===== */
        .phase-tracker {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.03);
            border-radius: 5px;
            padding: 4px 8px;
            overflow-x: auto;
            gap: 2px;
        }
        .phase-group {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .phase-group-label {
            font-size: 0.55rem;
            color: #666;
            text-transform: uppercase;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            padding: 2px;
        }
        .phase-btn {
            padding: 4px 6px;
            border: none;
            border-radius: 3px;
            background: rgba(255,255,255,0.05);
            color: #888;
            cursor: pointer;
            font-size: 0.65rem;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .phase-btn:hover { background: rgba(255,255,255,0.1); color: #ccc; }
        .phase-btn.active {
            background: #e94560;
            color: white;
            font-weight: bold;
        }
        .phase-btn.passed {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
        }
        .phase-separator {
            width: 1px;
            height: 20px;
            background: #333;
            margin: 0 4px;
        }
        .phase-next-btn {
            padding: 4px 10px;
            background: #4ecdc4;
            border: none;
            border-radius: 3px;
            color: #000;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }
        .phase-next-btn:hover { background: #3dbdb5; }

        /* ===== PLAYERS GRID ===== */
        .players-grid {
            display: grid;
            gap: 4px;
            overflow: hidden;
            min-height: 0;
        }
        .players-grid[data-players="2"] { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
        .players-grid[data-players="3"] { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .players-grid[data-players="4"] { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .players-grid[data-players="5"] { grid-template-columns: repeat(3, 1fr); grid-template-rows: 1fr 1fr; }
        .players-grid[data-players="6"] { grid-template-columns: repeat(3, 1fr); grid-template-rows: 1fr 1fr; }
        .players-grid[data-players="7"] { grid-template-columns: repeat(4, 1fr); grid-template-rows: 1fr 1fr; }
        .players-grid[data-players="8"] { grid-template-columns: repeat(4, 1fr); grid-template-rows: 1fr 1fr; }

        /* ===== PLAYER AREA ===== */
        .player-area {
            background: rgba(255,255,255,0.02);
            border-radius: 6px;
            padding: 5px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            border: 2px solid transparent;
            transition: border-color 0.3s;
            position: relative;
        }
        .player-area.is-me { border-color: rgba(233, 69, 96, 0.3); }
        .player-area.active-turn { border-color: #ffc107; }
        .player-area.dead { opacity: 0.5; }
        .player-area.drag-over-player {
            border-color: #4ecdc4 !important;
            background: rgba(78, 205, 196, 0.08);
        }
        .player-area.arrow-target {
            outline: 3px dashed #e94560;
            outline-offset: -3px;
        }

        .player-header {
            display: flex;
            align-items: center;
            gap: 6px;
            padding-bottom: 3px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 3px;
            flex-shrink: 0;
        }
        .player-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            cursor: pointer;
            position: relative;
        }
        .player-avatar:hover { opacity: 0.8; }
        .player-info { flex: 1; min-width: 0; }
        .player-info .name { font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-info .stats { display: flex; gap: 6px; font-size: 0.65rem; color: #888; }

        /* Life and Counters */
        .player-life-counters {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .player-life {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .player-life .life {
            font-size: 1rem;
            font-weight: bold;
            color: #4ecdc4;
            min-width: 28px;
            text-align: center;
        }
        .player-life button {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            line-height: 1;
        }
        .player-life button:hover { background: rgba(255,255,255,0.2); }

        /* Generic Counters */
        .generic-counters {
            display: flex;
            gap: 3px;
        }
        .generic-counter {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.1s;
        }
        .generic-counter:hover { transform: scale(1.1); }
        .generic-counter.red { background: #e94560; color: white; }
        .generic-counter.blue { background: #3498db; color: white; }
        .generic-counter.green { background: #27ae60; color: white; }
        .generic-counter.yellow { background: #f1c40f; color: #333; }
        .generic-counter.purple { background: #9b59b6; color: white; }

        .player-zones-mini {
            display: flex;
            gap: 3px;
            font-size: 0.6rem;
            margin-left: auto;
        }
        .mini-zone {
            background: rgba(0,0,0,0.3);
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
        }
        .mini-zone:hover { background: rgba(255,255,255,0.1); }

        /* ===== BATTLEFIELD ===== */
        .player-battlefield {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-height: 0;
            overflow-y: auto;
        }
        .battlefield-row {
            min-height: 40px;
            border-radius: 4px;
            padding: 2px 5px;
            position: relative;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .battlefield-row.drag-over {
            background: rgba(78, 205, 196, 0.15) !important;
            outline: 2px dashed #4ecdc4;
        }
        .creatures-row { background: rgba(233, 69, 96, 0.06); }
        .enchantments-row { background: rgba(78, 205, 196, 0.06); }
        .lands-row { background: rgba(255, 193, 7, 0.06); }
        .row-label {
            position: absolute;
            top: 1px;
            left: 5px;
            font-size: 0.5rem;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            padding-top: 10px;
            min-height: 28px;
            align-content: flex-start;
        }

        /* ===== BOTTOM ZONES + COMMAND ===== */
        .my-zones-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: flex-end;
            padding: 5px;
            background: rgba(255,255,255,0.02);
            border-radius: 5px;
            flex-shrink: 0;
        }
        .zone-stack {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s;
        }
        .zone-stack:hover { transform: translateY(-2px); }
        .stack-visual {
            position: relative;
            width: 42px;
            height: 59px;
        }
        .card-back {
            position: absolute;
            width: 42px;
            height: 59px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #333;
            border-radius: 3px;
        }
        .card-back.offset-1 { top: 2px; left: 2px; }
        .card-back.offset-2 { top: 4px; left: 4px; }
        .zone-count {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .zone-label {
            margin-top: 2px;
            font-size: 0.55rem;
            color: #777;
        }
        .graveyard-zone .top-card,
        .exile-zone .top-card {
            width: 42px;
            height: 59px;
            border-radius: 3px;
            overflow: hidden;
        }
        .graveyard-zone .top-card img,
        .exile-zone .top-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .command-zone-stack {
            border: 2px dashed #e94560;
            padding: 3px;
            border-radius: 4px;
            min-width: 50px;
            min-height: 65px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .command-zone-stack .commanders-container {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .command-zone-stack .card { width: 42px; height: 59px; }

        /* ===== MY HAND ===== */
        .my-hand-container {
            background: rgba(255,255,255,0.05);
            border-radius: 5px 5px 0 0;
            padding: 6px;
            border-top: 2px solid #e94560;
            flex-shrink: 0;
        }
        .my-hand-container h3 { margin-bottom: 4px; font-size: 0.75rem; }
        .hand-cards {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .hand-cards .card {
            width: 75px;
            height: 105px;
            cursor: grab;
            transition: transform 0.2s, margin 0.2s;
        }
        .hand-cards .card:hover {
            transform: translateY(-10px) scale(1.05);
            z-index: 100;
        }
        .hand-cards .card.dragging { opacity: 0.5; cursor: grabbing; }

        /* ===== SIDEBAR (Chat/Log) ===== */
        .sidebar-toggle {
            position: fixed;
            top: 45px;
            right: 8px;
            z-index: 100;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            color: white;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 0.7rem;
        }
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 240px;
            height: 100vh;
            background: rgba(10, 10, 18, 0.98);
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 200;
            padding: 6px;
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-close {
            align-self: flex-end;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .chat-panel, .log-panel {
            background: rgba(255,255,255,0.03);
            border-radius: 5px;
            padding: 6px;
            margin-bottom: 6px;
        }
        .chat-panel { max-height: 140px; display: flex; flex-direction: column; }
        .log-panel { flex: 1; overflow-y: auto; }
        .chat-panel h3, .log-panel h3 { margin-bottom: 4px; font-size: 0.7rem; color: #888; }
        .chat-messages { flex: 1; overflow-y: auto; margin-bottom: 4px; max-height: 60px; }
        .chat-message, .log-entry { font-size: 0.65rem; padding: 2px 0; }
        .chat-message .sender { color: #4ecdc4; }
        .log-entry { border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-entry .turn-num { color: #e94560; }
        .chat-input-container { display: flex; gap: 3px; }
        .chat-input-container input {
            flex: 1;
            padding: 4px;
            border: none;
            border-radius: 3px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.7rem;
        }
        .chat-input-container button {
            padding: 4px 6px;
            border: none;
            border-radius: 3px;
            background: #e94560;
            color: white;
            cursor: pointer;
            font-size: 0.7rem;
        }

        /* ===== CARDS ===== */
        .card {
            width: 46px;
            height: 64px;
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: transform 0.15s;
            border: 2px solid transparent;
        }
        .card:hover { transform: scale(1.08); z-index: 10; }
        .card.tapped { transform: rotate(90deg); margin: 5px 9px; }
        .card.tapped:hover { transform: rotate(90deg) scale(1.08); }
        .card.selected { border-color: #e94560; box-shadow: 0 0 6px rgba(233, 69, 96, 0.5); }
        .card.commander { border-color: #ffc107; }
        .card.dragging { opacity: 0.4; }
        .card.arrow-source { box-shadow: 0 0 10px #e94560; }
        .card.has-arrow { box-shadow: 0 0 8px 2px #ffc107; }
        .card.arrow-target-card {
            outline: 2px dashed #4ecdc4;
            outline-offset: 2px;
        }
        .card.arrow-target-card:hover {
            outline-color: #e94560;
            cursor: crosshair;
        }
        .card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .card .counters {
            position: absolute;
            bottom: 1px;
            right: 1px;
            background: rgba(0,0,0,0.85);
            padding: 1px 2px;
            border-radius: 2px;
            font-size: 0.45rem;
        }

        /* ===== ARROWS ===== */
        .arrows-svg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 500;
            overflow: visible;
        }
        .arrow-line {
            stroke: #e94560;
            stroke-width: 4;
            fill: none;
            marker-end: url(#arrowhead);
            pointer-events: visibleStroke;
            cursor: pointer;
            filter: drop-shadow(0 0 4px rgba(233, 69, 96, 0.9));
            transition: stroke-width 0.15s;
        }
        .arrow-line:hover {
            stroke: #ff6b8a;
            stroke-width: 6;
            filter: drop-shadow(0 0 6px rgba(255, 107, 138, 1));
        }

        /* ===== SELECTION BOX ===== */
        .selection-box {
            position: fixed;
            border: 2px dashed #e94560;
            background: rgba(233, 69, 96, 0.15);
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        /* ===== CONTEXT MENU ===== */
        .context-menu {
            position: fixed;
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 5px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 2000;
            min-width: 140px;
            overflow: hidden;
            display: none;
        }
        .context-menu.show { display: block; }
        .context-menu-item {
            padding: 6px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .context-menu-item:hover { background: rgba(233, 69, 96, 0.2); }
        .context-menu-item.disabled { opacity: 0.5; cursor: not-allowed; }
        .context-menu-divider { height: 1px; background: #333; margin: 2px 0; }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1500;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            max-width: 90vw;
            max-height: 80vh;
            overflow: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .modal-header h3 { font-size: 0.9rem; }
        .modal-header button {
            background: #333;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        .modal-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }
        .modal-cards .card { width: 85px; height: 119px; }

        /* Library Viewer */
        .library-viewer-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
        }
        .library-viewer-cards .card {
            width: 70px;
            height: 98px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .library-viewer-cards .card:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.8);
            z-index: 10;
        }

        /* Card Modal */
        .card-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 10px;
        }
        .card-modal.show { display: flex; }
        .card-modal img { max-height: 55vh; border-radius: 8px; }
        .card-modal .actions { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
        .card-modal button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        .card-modal .close { background: #333; color: white; }
        .card-modal .action-btn { background: #e94560; color: white; }

        /* Scry Modal */
        .scry-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .scry-modal.show { display: flex; }
        .scry-content {
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            max-width: 90vw;
        }
        .scry-content h3 { margin-bottom: 10px; font-size: 0.9rem; }
        .scry-cards {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .scry-cards .card { width: 90px; height: 126px; cursor: grab; }
        .scry-zones {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 10px 0;
        }
        .scry-zone {
            min-width: 100px;
            min-height: 60px;
            border: 2px dashed #444;
            border-radius: 5px;
            padding: 6px;
            transition: all 0.2s;
        }
        .scry-zone.drag-over { border-color: #4ecdc4; background: rgba(78, 205, 196, 0.1); }
        .scry-zone span { font-size: 0.7rem; color: #888; display: block; margin-bottom: 4px; }
        .scry-zone .scry-cards-list { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; }
        .scry-zone .card { width: 45px; height: 63px; }
        .scry-content .btn {
            padding: 6px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 6px;
        }
        .scry-content .btn.primary { background: #e94560; color: white; }

        /* Reveal Overlay */
        .reveal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .reveal-overlay.show { display: flex; animation: fadeIn 0.3s; }
        .reveal-overlay img { max-height: 45vh; border-radius: 8px; box-shadow: 0 0 30px rgba(233, 69, 96, 0.5); }
        .reveal-overlay p { margin-top: 10px; font-size: 0.9rem; color: #fff; }

        /* ===== OVERLAYS ===== */
        .dead-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e94560;
            font-weight: bold;
            font-size: 0.85rem;
            border-radius: 5px;
            z-index: 5;
        }
        .winner-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2000;
        }
        .winner-overlay.show { display: flex; }
        .winner-overlay h1 { color: #ffc107; font-size: 1.8rem; margin-bottom: 10px; }
        .winner-overlay a {
            padding: 8px 16px;
            background: #e94560;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes cardDraw {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes shuffle {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px) rotate(-1deg); }
            75% { transform: translateX(2px) rotate(1deg); }
        }
        .card.drawing { animation: cardDraw 0.25s ease-out; }
        .zone-stack.shuffling .card-back { animation: shuffle 0.1s ease-in-out 5; }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <button class="sidebar-toggle" onclick="toggleSidebar()">Chat/Log</button>

    <div class="sidebar" id="sidebar">
        <button class="sidebar-close" onclick="toggleSidebar()">&times;</button>
        <div class="chat-panel">
            <h3>Chat</h3>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Mensagem..." onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()">Enviar</button>
            </div>
        </div>
        <div class="log-panel">
            <h3>Log</h3>
            <div id="actionLog"></div>
        </div>
    </div>

    <!-- SVG for Arrows -->
    <svg class="arrows-svg" id="arrowsSvg" style="pointer-events: none;">
        <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#e94560" />
            </marker>
        </defs>
    </svg>

    <div class="game-container" id="gameContainer" style="display: none;">
        <div class="game-header">
            <div class="turn-info">
                <span class="turn" id="turnNumber">Turno 1</span>
                <span class="active" id="activePlayer">Vez de: -</span>
            </div>
            <div class="connection-status">
                <div class="connection-dot" id="connectionDot"></div>
                <span id="connectionText">Conectando...</span>
            </div>
            <div class="game-controls">
                <button onclick="sendAction('draw_card')" title="D">Comprar</button>
                <button onclick="sendAction('next_turn')" class="primary" title="P">Passar Turno</button>
                <button onclick="if(confirm('Conceder?')) sendAction('concede')" style="background:#c0392b;">Conceder</button>
            </div>
        </div>

        <!-- Phase Tracker -->
        <div class="phase-tracker" id="phaseTracker">
            <div class="phase-group">
                <span class="phase-group-label">Inicio</span>
                <button class="phase-btn" data-phase="untap" onclick="goToPhase('untap')">Desvirar</button>
                <button class="phase-btn" data-phase="upkeep" onclick="goToPhase('upkeep')">Manutencao</button>
                <button class="phase-btn" data-phase="draw" onclick="goToPhase('draw')">Compra</button>
            </div>
            <div class="phase-separator"></div>
            <div class="phase-group">
                <span class="phase-group-label">Main1</span>
                <button class="phase-btn" data-phase="main1" onclick="goToPhase('main1')">Principal 1</button>
            </div>
            <div class="phase-separator"></div>
            <div class="phase-group">
                <span class="phase-group-label">Combate</span>
                <button class="phase-btn" data-phase="combat_begin" onclick="goToPhase('combat_begin')">Inicio</button>
                <button class="phase-btn" data-phase="combat_attackers" onclick="goToPhase('combat_attackers')">Atacantes</button>
                <button class="phase-btn" data-phase="combat_blockers" onclick="goToPhase('combat_blockers')">Bloqueadores</button>
                <button class="phase-btn" data-phase="combat_damage" onclick="goToPhase('combat_damage')">Dano</button>
                <button class="phase-btn" data-phase="combat_end" onclick="goToPhase('combat_end')">Fim</button>
            </div>
            <div class="phase-separator"></div>
            <div class="phase-group">
                <span class="phase-group-label">Main2</span>
                <button class="phase-btn" data-phase="main2" onclick="goToPhase('main2')">Principal 2</button>
            </div>
            <div class="phase-separator"></div>
            <div class="phase-group">
                <span class="phase-group-label">Final</span>
                <button class="phase-btn" data-phase="end" onclick="goToPhase('end')">Etapa Final</button>
                <button class="phase-btn" data-phase="cleanup" onclick="goToPhase('cleanup')">Limpeza</button>
            </div>
            <button class="phase-next-btn" onclick="sendAction('next_phase')" title="N">Proxima Fase &rarr;</button>
        </div>

        <!-- Dynamic Players Grid -->
        <div class="players-grid" id="playersGrid"></div>

        <!-- Bottom Zones Row -->
        <div class="my-zones-row">
            <div class="zone-stack library-zone" id="myLibrary"
                 onclick="showLibraryMenu()" oncontextmenu="showLibraryContextMenu(event); return false;">
                <div class="stack-visual">
                    <div class="card-back"></div>
                    <div class="card-back offset-1"></div>
                    <div class="card-back offset-2"></div>
                </div>
                <span class="zone-count" id="libraryCount">0</span>
                <span class="zone-label">Biblioteca</span>
            </div>
            <div class="zone-stack graveyard-zone" id="myGraveyard"
                 onclick="showZoneViewer('graveyard')"
                 ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                 ondrop="handleDropToMyZone(event, 'graveyard')">
                <div class="top-card" id="graveyardTopCard"></div>
                <span class="zone-count" id="graveyardCount">0</span>
                <span class="zone-label">Cemiterio</span>
            </div>
            <div class="zone-stack exile-zone" id="myExile"
                 onclick="showZoneViewer('exile')"
                 ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                 ondrop="handleDropToMyZone(event, 'exile')">
                <div class="top-card" id="exileTopCard"></div>
                <span class="zone-count" id="exileCount">0</span>
                <span class="zone-label">Exilio</span>
            </div>
            <div class="command-zone-stack" id="myCommandZone"
                 ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                 ondrop="handleDropToMyZone(event, 'command')">
                <div class="commanders-container" id="commanderCards"></div>
                <span class="zone-label">Comando</span>
            </div>
        </div>

        <!-- My Hand -->
        <div class="my-hand-container" id="myHandContainer">
            <h3>Sua Mao (<span id="handCount">0</span>)</h3>
            <div class="hand-cards" id="myHand"></div>
        </div>
    </div>

    <!-- Selection Box -->
    <div class="selection-box" id="selectionBox"></div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div id="contextMenuItems"></div>
    </div>

    <!-- Zone Viewer Modal -->
    <div class="modal-overlay" id="zoneViewerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="zoneViewerTitle">Zona</h3>
                <button onclick="closeZoneViewer()">Fechar</button>
            </div>
            <div class="modal-cards" id="zoneViewerCards"></div>
        </div>
    </div>

    <!-- Library Viewer Modal -->
    <div class="modal-overlay" id="libraryViewerModal">
        <div class="modal-content" style="max-width: 85vw;">
            <div class="modal-header">
                <h3 id="libraryViewerTitle">Sua Biblioteca</h3>
                <span style="font-size:0.7rem;color:#888;">(Clique em uma carta para mover | Sera embaralhada ao fechar)</span>
                <button onclick="closeLibraryViewer()">Fechar e Embaralhar</button>
            </div>
            <div class="library-viewer-cards" id="libraryViewerCards"></div>
        </div>
    </div>

    <!-- Scry Modal -->
    <div class="scry-modal" id="scryModal">
        <div class="scry-content">
            <h3 id="scryTitle">Videncia</h3>
            <div class="scry-cards" id="scryCards"></div>
            <div class="scry-zones">
                <div class="scry-zone" id="scryTop"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                     ondrop="handleScryDrop(event, 'top')">
                    <span>Topo</span>
                    <div class="scry-cards-list" id="scryTopCards"></div>
                </div>
                <div class="scry-zone" id="scryBottom"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                     ondrop="handleScryDrop(event, 'bottom')">
                    <span>Fundo</span>
                    <div class="scry-cards-list" id="scryBottomCards"></div>
                </div>
            </div>
            <button class="btn primary" onclick="confirmScry()">Confirmar</button>
            <button class="btn" style="background:#333;color:white;margin-left:6px;" onclick="closeScryModal()">Cancelar</button>
        </div>
    </div>

    <!-- Reveal Overlay -->
    <div class="reveal-overlay" id="revealOverlay">
        <img id="revealedCardImage" src="" alt="">
        <p id="revealedCardText"></p>
    </div>

    <!-- Card Modal -->
    <div class="card-modal" id="cardModal">
        <img id="modalImage" src="" alt="">
        <div class="actions" id="modalActions"></div>
    </div>

    <!-- Winner Overlay -->
    <div class="winner-overlay" id="winnerOverlay">
        <h1 id="winnerText">Vencedor!</h1>
        <a id="lobbyLink" href="/lobby/">Voltar ao Lobby</a>
    </div>

    <!-- Counter Adjustment Modal -->
    <div class="modal-overlay" id="counterModal">
        <div class="modal-content" style="text-align:center;min-width:200px;">
            <div class="modal-header">
                <h3 id="counterModalTitle">Marcador</h3>
                <button onclick="closeCounterModal()">Fechar</button>
            </div>
            <div style="display:flex;align-items:center;justify-content:center;gap:15px;margin:15px 0;">
                <button onclick="adjustCounter(-1)" style="width:40px;height:40px;font-size:1.5rem;border:none;background:#e94560;color:white;border-radius:50%;cursor:pointer;">-</button>
                <span id="counterValue" style="font-size:2rem;font-weight:bold;min-width:50px;">0</span>
                <button onclick="adjustCounter(1)" style="width:40px;height:40px;font-size:1.5rem;border:none;background:#4ecdc4;color:white;border-radius:50%;cursor:pointer;">+</button>
            </div>
        </div>
    </div>

    <script>
        // ===== CONSTANTS =====
        const gameId = '{{ game.id }}';
        const myPlayerId = '{{ player.id }}';
        const mySeat = {{ game_player.seat_position }};
        const myNickname = '{{ player.nickname }}';
        const csrfToken = '{{ csrf_token }}';
        const tabId = '{{ tab_id|default:"" }}';

        const PHASES = ['untap', 'upkeep', 'draw', 'main1', 'combat_begin', 'combat_attackers',
                        'combat_blockers', 'combat_damage', 'combat_end', 'main2', 'end', 'cleanup'];

        // ===== STATE =====
        let socket = null;
        let gameState = null;
        let selectedCard = null;
        let selectedCards = new Set();
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let draggedCard = null;
        let draggedCardData = null;
        let scryCardsData = [];
        let isSelecting = false;
        let selectionStart = { x: 0, y: 0 };

        // Arrow state
        let arrowMode = false;
        let arrowSourceCard = null;
        let arrows = []; // {sourceCardId, targetType: 'player'|'card', targetId: seatNumber|cardId}

        // Counter modal state
        let counterModalData = { seat: null, color: null };

        // Player counters (local state for generic counters)
        let playerCounters = {}; // seat -> {red: 0, blue: 0, green: 0, yellow: 0, purple: 0}

        // ===== WEBSOCKET =====
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const params = new URLSearchParams();
            if (tabId) params.set('tab', tabId);
            params.set('player_id', myPlayerId);
            const wsUrl = `${protocol}//${window.location.host}/ws/game/${gameId}/?${params.toString()}`;
            socket = new WebSocket(wsUrl);

            socket.onopen = function() {
                reconnectAttempts = 0;
                updateConnectionStatus(true);
                socket.send(JSON.stringify({ action: 'get_state' }));
            };

            socket.onclose = function() {
                updateConnectionStatus(false);
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                }
            };

            socket.onerror = function() { updateConnectionStatus(false); };
            socket.onmessage = function(e) { handleMessage(JSON.parse(e.data)); };
        }

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            dot.classList.toggle('connected', connected);
            text.textContent = connected ? 'Conectado' : 'Desconectado';
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'game_state':
                    gameState = data.state;
                    renderGame();
                    break;
                case 'chat':
                    addChatMessage(data.sender, data.message);
                    break;
                case 'action_result':
                    if (!data.result.success && !data.result.private) {
                        alert(data.result.error || 'Erro ao executar acao');
                    }
                    break;
                case 'private_action':
                    handlePrivateAction(data);
                    break;
                case 'reveal':
                    showRevealAnimation(data.card);
                    break;
            }
        }

        function handlePrivateAction(data) {
            if (data.action === 'scry' || data.action === 'look_top') {
                showScryModal(data.data.cards, data.action === 'scry');
            } else if (data.action === 'view_library') {
                showLibraryViewerModal(data.data.cards);
            }
        }

        function sendAction(action, data = {}) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ action, data }));
            } else {
                alert('Conexao perdida. Reconectando...');
                connectWebSocket();
            }
        }

        function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ action: 'chat', message, sender: myNickname }));
                input.value = '';
            }
        }

        function addChatMessage(sender, message) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'chat-message';
            div.innerHTML = `<span class="sender">${sender}:</span> ${message}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // ===== PHASE SYSTEM =====
        function goToPhase(phase) {
            sendAction('go_to_phase', { phase });
        }

        function updatePhaseTracker() {
            if (!gameState) return;
            const currentPhase = gameState.current_phase;
            const currentIdx = PHASES.indexOf(currentPhase);

            document.querySelectorAll('.phase-btn').forEach(btn => {
                const phase = btn.dataset.phase;
                const phaseIdx = PHASES.indexOf(phase);
                btn.classList.remove('active', 'passed');
                if (phase === currentPhase) {
                    btn.classList.add('active');
                } else if (phaseIdx < currentIdx) {
                    btn.classList.add('passed');
                }
            });
        }

        // ===== RENDER =====
        function renderGame() {
            if (!gameState) return;
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('gameContainer').style.display = 'grid';

            document.getElementById('turnNumber').textContent = `Turno ${gameState.turn_number}`;
            document.getElementById('activePlayer').textContent = `Vez de: ${gameState.active_player_name || '-'}`;

            updatePhaseTracker();

            if (gameState.status === 'finished' && gameState.winner_id) {
                const winner = gameState.players.find(p => p.id === gameState.winner_id);
                if (winner) {
                    document.getElementById('winnerText').textContent = `${winner.nickname} venceu!`;
                    document.getElementById('winnerOverlay').classList.add('show');
                }
            }

            // Initialize player counters if not exists
            gameState.players.forEach(p => {
                if (!playerCounters[p.seat_position]) {
                    playerCounters[p.seat_position] = { red: 0, blue: 0, green: 0, yellow: 0, purple: 0 };
                }
            });

            renderPlayersGrid();
            renderMyZones();
            renderMyHand();
            renderActionLog();
            renderArrows();
        }

        function renderPlayersGrid() {
            const container = document.getElementById('playersGrid');
            const playerCount = gameState.players.length;
            container.setAttribute('data-players', playerCount);

            const sortedPlayers = [...gameState.players].sort((a, b) => {
                if (a.seat_position === mySeat) return 1;
                if (b.seat_position === mySeat) return -1;
                return a.seat_position - b.seat_position;
            });

            container.innerHTML = sortedPlayers.map(player => {
                const isMe = player.seat_position === mySeat;
                const zones = gameState.zones_data[player.seat_position];
                const isActive = player.seat_position === gameState.active_player_seat;
                return renderPlayerArea(player, zones, isMe, isActive);
            }).join('');
        }

        function renderPlayerArea(player, zones, isMe, isActive) {
            const classes = ['player-area'];
            if (isMe) classes.push('is-me');
            if (isActive) classes.push('active-turn');
            if (!player.is_alive) classes.push('dead');

            const creatures = [], enchantments = [], lands = [];
            zones.battlefield.forEach(card => {
                const row = card.battlefield_row || getCardRow(card.type_line);
                if (row === 'creatures') creatures.push(card);
                else if (row === 'lands') lands.push(card);
                else enchantments.push(card);
            });

            const counters = playerCounters[player.seat_position] || { red: 0, blue: 0, green: 0, yellow: 0, purple: 0 };

            return `
                <div class="${classes.join(' ')}" data-seat="${player.seat_position}" id="playerArea-${player.seat_position}"
                     ondragover="handlePlayerDragOver(event, ${player.seat_position})"
                     ondragleave="handlePlayerDragLeave(event)"
                     ondrop="handlePlayerDrop(event, ${player.seat_position})"
                     onclick="handlePlayerAreaClick(event, ${player.seat_position})">
                    ${!player.is_alive ? '<div class="dead-overlay">ELIMINADO</div>' : ''}
                    <div class="player-header">
                        <div class="player-avatar" style="background-color: ${player.avatar_color || '#e94560'}"
                             onclick="event.stopPropagation(); startArrowToPlayer(${player.seat_position})"
                             title="Clique para apontar seta">${player.nickname.charAt(0).toUpperCase()}</div>
                        <div class="player-info">
                            <div class="name">${player.nickname}${isMe ? ' (Voce)' : ''}</div>
                        </div>
                        <div class="player-life-counters">
                            <div class="player-life">
                                <button onclick="event.stopPropagation(); changeLife(${player.seat_position}, -1)">-</button>
                                <span class="life">${player.life}</span>
                                <button onclick="event.stopPropagation(); changeLife(${player.seat_position}, 1)">+</button>
                            </div>
                            <div class="generic-counters">
                                <div class="generic-counter red" onclick="event.stopPropagation(); openCounterModal(${player.seat_position}, 'red')">${counters.red || ''}</div>
                                <div class="generic-counter blue" onclick="event.stopPropagation(); openCounterModal(${player.seat_position}, 'blue')">${counters.blue || ''}</div>
                                <div class="generic-counter green" onclick="event.stopPropagation(); openCounterModal(${player.seat_position}, 'green')">${counters.green || ''}</div>
                                <div class="generic-counter yellow" onclick="event.stopPropagation(); openCounterModal(${player.seat_position}, 'yellow')">${counters.yellow || ''}</div>
                                <div class="generic-counter purple" onclick="event.stopPropagation(); openCounterModal(${player.seat_position}, 'purple')">${counters.purple || ''}</div>
                            </div>
                        </div>
                        <div class="player-zones-mini">
                            <span class="mini-zone" title="Biblioteca">${zones.library_count}</span>
                            <span class="mini-zone" title="Mao">${zones.hand.length}</span>
                            <span class="mini-zone" title="Cemiterio" onclick="event.stopPropagation(); showOpponentZone(${player.seat_position}, 'graveyard')">${zones.graveyard.length}</span>
                            <span class="mini-zone" title="Exilio" onclick="event.stopPropagation(); showOpponentZone(${player.seat_position}, 'exile')">${zones.exile.length}</span>
                        </div>
                    </div>
                    <div class="player-battlefield">
                        <div class="battlefield-row creatures-row" data-row="creatures" data-seat="${player.seat_position}"
                             ondragover="handleRowDragOver(event)" ondragleave="handleRowDragLeave(event)"
                             ondrop="handleRowDrop(event, ${player.seat_position}, 'creatures')">
                            <span class="row-label">Criaturas</span>
                            <div class="cards-container">${renderBattlefieldCards(creatures, isMe)}</div>
                        </div>
                        <div class="battlefield-row enchantments-row" data-row="enchantments" data-seat="${player.seat_position}"
                             ondragover="handleRowDragOver(event)" ondragleave="handleRowDragLeave(event)"
                             ondrop="handleRowDrop(event, ${player.seat_position}, 'enchantments')">
                            <span class="row-label">Encant/Artefatos</span>
                            <div class="cards-container">${renderBattlefieldCards(enchantments, isMe)}</div>
                        </div>
                        <div class="battlefield-row lands-row" data-row="lands" data-seat="${player.seat_position}"
                             ondragover="handleRowDragOver(event)" ondragleave="handleRowDragLeave(event)"
                             ondrop="handleRowDrop(event, ${player.seat_position}, 'lands')">
                            <span class="row-label">Terrenos</span>
                            <div class="cards-container">${renderBattlefieldCards(lands, isMe)}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getCardRow(typeLine) {
            if (!typeLine) return 'enchantments';
            const lower = typeLine.toLowerCase();
            if (lower.includes('creature')) return 'creatures';
            if (lower.includes('land')) return 'lands';
            return 'enchantments';
        }

        function renderBattlefieldCards(cards, isMe) {
            if (!cards.length) return '';
            return cards.map(card => {
                let countersHtml = '';
                if (card.counters && Object.keys(card.counters).length > 0) {
                    const text = Object.entries(card.counters).filter(([k,v]) => v > 0).map(([k,v]) => `${k}:${v}`).join(' ');
                    if (text) countersHtml = `<div class="counters">${text}</div>`;
                }
                const isSelected = selectedCards.has(card.id);
                const isArrowSource = arrowSourceCard === card.id;
                const hasArrowFrom = arrows.some(a => a.sourceCardId === card.id);
                const hasArrowTo = arrows.some(a => a.targetType === 'card' && a.targetId === card.id);
                const hasArrow = hasArrowFrom || hasArrowTo;
                const draggable = isMe ? 'draggable="true"' : '';
                const dragStart = isMe ? `ondragstart="handleDragStart(event, '${card.id}', 'battlefield')"` : '';
                // Context menu for all battlefield cards (own cards have more options)
                const contextMenu = `oncontextmenu="showBattlefieldContextMenu(event, ${JSON.stringify(card).replace(/"/g, '&quot;')}, ${isMe}); return false;"`;

                return `
                    <div class="card ${card.is_tapped ? 'tapped' : ''} ${card.is_commander ? 'commander' : ''} ${isSelected ? 'selected' : ''} ${isArrowSource ? 'arrow-source' : ''} ${hasArrow ? 'has-arrow' : ''}"
                         data-id="${card.id}" ${draggable}
                         ${dragStart}
                         onclick="handleBattlefieldCardClick(event, '${card.id}', ${isMe})"
                         ondblclick="${isMe ? `event.stopPropagation(); toggleTap('${card.id}')` : ''}"
                         ${contextMenu}>
                        <img src="${card.image_small}" alt="${card.name}">
                        ${countersHtml}
                    </div>
                `;
            }).join('');
        }

        function renderMyZones() {
            const zones = gameState.zones_data[mySeat];
            if (!zones) return;

            document.getElementById('libraryCount').textContent = zones.library_count;
            document.getElementById('graveyardCount').textContent = zones.graveyard.length;
            document.getElementById('exileCount').textContent = zones.exile.length;

            const gravTop = document.getElementById('graveyardTopCard');
            if (zones.graveyard.length > 0) {
                const top = zones.graveyard[zones.graveyard.length - 1];
                gravTop.innerHTML = `<img src="${top.image_small}" alt="${top.name}">`;
            } else gravTop.innerHTML = '';

            const exileTop = document.getElementById('exileTopCard');
            if (zones.exile.length > 0) {
                const top = zones.exile[zones.exile.length - 1];
                exileTop.innerHTML = `<img src="${top.image_small}" alt="${top.name}">`;
            } else exileTop.innerHTML = '';

            document.getElementById('commanderCards').innerHTML = zones.command.map(c => `
                <div class="card commander" data-id="${c.id}" draggable="true"
                     ondragstart="handleDragStart(event, '${c.id}', 'command')"
                     onclick="showCard('${c.id}', '${c.image_normal}', '${c.name}', 'command', true)"
                     ondblclick="event.stopPropagation(); moveCard('${c.id}', 'battlefield')"
                     oncontextmenu="showCommandContextMenu(event, '${c.id}'); return false;">
                    <img src="${c.image_small}" alt="${c.name}">
                </div>
            `).join('');
        }

        function renderMyHand() {
            const zones = gameState.zones_data[mySeat];
            const handCards = zones ? zones.hand : [];
            document.getElementById('handCount').textContent = handCards.length;

            const container = document.getElementById('myHand');
            if (!handCards.length) {
                container.innerHTML = '<div style="color:#555;font-size:0.75rem;">Mao vazia</div>';
                return;
            }

            container.innerHTML = handCards.map(card => `
                <div class="card" data-id="${card.id}" draggable="true"
                     ondragstart="handleDragStart(event, '${card.id}', 'hand')"
                     onclick="showCard('${card.id}', '${card.image_normal}', '${card.name}', 'hand', true)"
                     oncontextmenu="showHandContextMenu(event, ${JSON.stringify(card).replace(/"/g, '&quot;')}); return false;">
                    <img src="${card.image_normal}" alt="${card.name}">
                </div>
            `).join('');
        }

        function renderActionLog() {
            const container = document.getElementById('actionLog');
            if (!gameState.recent_actions) return;
            container.innerHTML = gameState.recent_actions.map(action => `
                <div class="log-entry"><span class="turn-num">[T${action.turn_number}]</span> ${action.display_text}</div>
            `).join('');
        }

        // ===== ARROWS =====
        function startArrowFromCard(cardId) {
            arrowMode = true;
            arrowSourceCard = cardId;
            // Highlight all potential targets
            document.querySelectorAll('.player-area').forEach(el => el.classList.add('arrow-target'));
            document.querySelectorAll('.card').forEach(el => {
                if (el.dataset.id !== cardId) el.classList.add('arrow-target-card');
            });
            renderGame();
        }

        function startArrowToPlayer(targetSeat) {
            if (arrowMode && arrowSourceCard) {
                // Complete the arrow to player
                arrows.push({ sourceCardId: arrowSourceCard, targetType: 'player', targetId: targetSeat });
                cancelArrowMode();
                renderArrows();
            }
        }

        function startArrowToCard(targetCardId) {
            if (arrowMode && arrowSourceCard && targetCardId !== arrowSourceCard) {
                // Complete the arrow to card
                arrows.push({ sourceCardId: arrowSourceCard, targetType: 'card', targetId: targetCardId });
                cancelArrowMode();
                renderArrows();
            }
        }

        function cancelArrowMode() {
            arrowMode = false;
            arrowSourceCard = null;
            document.querySelectorAll('.player-area').forEach(el => el.classList.remove('arrow-target'));
            document.querySelectorAll('.card').forEach(el => el.classList.remove('arrow-target-card'));
            renderGame();
        }

        function handlePlayerAreaClick(event, seat) {
            if (arrowMode && arrowSourceCard) {
                arrows.push({ sourceCardId: arrowSourceCard, targetType: 'player', targetId: seat });
                cancelArrowMode();
                renderArrows();
            }
        }

        function renderArrows() {
            // Use requestAnimationFrame to ensure DOM is updated
            requestAnimationFrame(() => {
                const svg = document.getElementById('arrowsSvg');
                // Clear existing arrows (except defs)
                const defs = svg.querySelector('defs');
                svg.innerHTML = '';
                svg.appendChild(defs);

                arrows.forEach((arrow, idx) => {
                    const sourceEl = document.querySelector(`[data-id="${arrow.sourceCardId}"]`);
                    let targetEl;

                    if (arrow.targetType === 'player') {
                        targetEl = document.getElementById(`playerArea-${arrow.targetId}`);
                    } else if (arrow.targetType === 'card') {
                        targetEl = document.querySelector(`[data-id="${arrow.targetId}"]`);
                    } else {
                        // Legacy support for old format
                        targetEl = document.getElementById(`playerArea-${arrow.targetSeat}`);
                    }

                    if (!sourceEl || !targetEl) return;

                    const sourceRect = sourceEl.getBoundingClientRect();
                    const targetRect = targetEl.getBoundingClientRect();

                    const x1 = sourceRect.left + sourceRect.width / 2;
                    const y1 = sourceRect.top + sourceRect.height / 2;
                    const x2 = targetRect.left + targetRect.width / 2;
                    const y2 = arrow.targetType === 'card'
                        ? targetRect.top + targetRect.height / 2
                        : targetRect.top + 30;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x1);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x2);
                    line.setAttribute('y2', y2);
                    line.setAttribute('class', 'arrow-line');
                    line.setAttribute('data-arrow-idx', idx);
                    line.onclick = (e) => {
                        e.stopPropagation();
                        removeArrow(idx);
                    };
                    svg.appendChild(line);
                });
            });
        }

        function removeArrow(idx) {
            arrows.splice(idx, 1);
            renderGame();
        }

        function removeArrowsFromCard(cardId) {
            arrows = arrows.filter(a => a.sourceCardId !== cardId);
            renderGame();
        }

        function clearAllArrows() {
            arrows = [];
            renderGame();
        }

        // ===== GENERIC COUNTERS =====
        function openCounterModal(seat, color) {
            counterModalData = { seat, color };
            const value = playerCounters[seat]?.[color] || 0;
            document.getElementById('counterValue').textContent = value;
            document.getElementById('counterModalTitle').textContent = `Marcador ${color.charAt(0).toUpperCase() + color.slice(1)}`;
            document.getElementById('counterModal').classList.add('show');
        }

        function closeCounterModal() {
            document.getElementById('counterModal').classList.remove('show');
        }

        function adjustCounter(delta) {
            const { seat, color } = counterModalData;
            if (!playerCounters[seat]) playerCounters[seat] = { red: 0, blue: 0, green: 0, yellow: 0, purple: 0 };
            playerCounters[seat][color] = Math.max(0, (playerCounters[seat][color] || 0) + delta);
            document.getElementById('counterValue').textContent = playerCounters[seat][color];
            renderGame();
        }

        // ===== DRAG AND DROP =====
        function handleDragStart(e, cardId, zone) {
            draggedCard = cardId;
            draggedCardData = { id: cardId, zone };
            e.dataTransfer.setData('text/plain', cardId);
            e.dataTransfer.effectAllowed = 'move';
            e.target.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handlePlayerDragOver(e, targetSeat) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over-player');
        }

        function handlePlayerDragLeave(e) {
            e.currentTarget.classList.remove('drag-over-player');
        }

        function handlePlayerDrop(e, targetSeat) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over-player');
            if (e.target.closest('.battlefield-row')) return;
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            if (!draggedCard) return;
            sendAction('move_card', { object_id: draggedCard, zone: 'battlefield', target_seat: targetSeat });
            draggedCard = null;
            draggedCardData = null;
        }

        function handleRowDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('drag-over');
        }

        function handleRowDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleRowDrop(e, targetSeat, row) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('drag-over');
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            document.querySelectorAll('.drag-over-player').forEach(el => el.classList.remove('drag-over-player'));
            if (!draggedCard) return;
            sendAction('move_card', { object_id: draggedCard, zone: 'battlefield', target_seat: targetSeat, row: row });
            draggedCard = null;
            draggedCardData = null;
        }

        function handleDropToMyZone(e, zone) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            if (!draggedCard) return;
            sendAction('move_card', { object_id: draggedCard, zone });
            draggedCard = null;
            draggedCardData = null;
        }

        // ===== CARD INTERACTIONS =====
        function handleCardClick(e, cardId, imageUrl, cardName, zone, isMe) {
            e.stopPropagation();
            if (arrowMode) {
                // Cancel arrow mode on card click
                cancelArrowMode();
                return;
            }
            if (e.shiftKey && isMe) {
                if (selectedCards.has(cardId)) {
                    selectedCards.delete(cardId);
                } else {
                    selectedCards.add(cardId);
                }
                renderGame();
                return;
            }
            showCard(cardId, imageUrl, cardName, zone, isMe);
        }

        // Battlefield cards: single click only for selection, not opening modal
        function handleBattlefieldCardClick(e, cardId, isMe) {
            e.stopPropagation();
            // If in arrow mode, target this card with the arrow
            if (arrowMode && arrowSourceCard && cardId !== arrowSourceCard) {
                startArrowToCard(cardId);
                return;
            }
            if (arrowMode) {
                cancelArrowMode();
                return;
            }
            // Shift+click for multi-select
            if (e.shiftKey && isMe) {
                if (selectedCards.has(cardId)) {
                    selectedCards.delete(cardId);
                } else {
                    selectedCards.add(cardId);
                }
                renderGame();
                return;
            }
            // Regular click: toggle selection (don't open modal)
            if (isMe) {
                if (selectedCards.has(cardId)) {
                    selectedCards.delete(cardId);
                } else {
                    // Clear other selections unless shift is held
                    selectedCards.clear();
                    selectedCards.add(cardId);
                }
                renderGame();
            }
            // For opponent cards, single click does nothing (use right-click to view)
        }

        function toggleTap(cardId) {
            if (selectedCards.size > 0 && selectedCards.has(cardId)) {
                selectedCards.forEach(id => sendAction('tap_card', { object_id: id }));
                selectedCards.clear();
            } else {
                sendAction('tap_card', { object_id: cardId });
            }
        }

        // ===== MULTI-SELECT =====
        document.addEventListener('mousedown', function(e) {
            if (e.button !== 0) return;
            if (e.target.closest('.card, .context-menu, .card-modal, .modal-overlay, button, input, .sidebar, .phase-tracker')) return;
            const playerArea = e.target.closest('.player-area.is-me');
            if (!playerArea) return;

            isSelecting = true;
            selectionStart = { x: e.clientX, y: e.clientY };
            const box = document.getElementById('selectionBox');
            box.style.left = e.clientX + 'px';
            box.style.top = e.clientY + 'px';
            box.style.width = '0px';
            box.style.height = '0px';
            box.style.display = 'block';
        });

        document.addEventListener('mousemove', function(e) {
            if (!isSelecting) return;
            const box = document.getElementById('selectionBox');
            const x = Math.min(e.clientX, selectionStart.x);
            const y = Math.min(e.clientY, selectionStart.y);
            const w = Math.abs(e.clientX - selectionStart.x);
            const h = Math.abs(e.clientY - selectionStart.y);
            box.style.left = x + 'px';
            box.style.top = y + 'px';
            box.style.width = w + 'px';
            box.style.height = h + 'px';
        });

        document.addEventListener('mouseup', function(e) {
            if (!isSelecting) return;
            isSelecting = false;
            const box = document.getElementById('selectionBox');
            const boxRect = box.getBoundingClientRect();
            box.style.display = 'none';
            if (boxRect.width < 10 || boxRect.height < 10) return;
            const myArea = document.querySelector('.player-area.is-me');
            if (!myArea) return;
            const cards = myArea.querySelectorAll('.card[data-id]');
            selectedCards.clear();
            cards.forEach(card => {
                const cardRect = card.getBoundingClientRect();
                if (rectsIntersect(boxRect, cardRect)) {
                    selectedCards.add(card.dataset.id);
                }
            });
            renderGame();
        });

        function rectsIntersect(r1, r2) {
            return !(r2.left > r1.right || r2.right < r1.left || r2.top > r1.bottom || r2.bottom < r1.top);
        }

        // ===== CONTEXT MENUS =====
        function showContextMenu(e, items) {
            e.preventDefault();
            hideContextMenu();
            const menu = document.getElementById('contextMenu');
            const container = document.getElementById('contextMenuItems');
            container.innerHTML = items.map(item => {
                if (item.divider) return '<div class="context-menu-divider"></div>';
                return `<div class="context-menu-item" onclick="${item.action}">${item.label}</div>`;
            }).join('');
            menu.style.left = Math.min(e.clientX, window.innerWidth - 160) + 'px';
            menu.style.top = Math.min(e.clientY, window.innerHeight - menu.offsetHeight - 20) + 'px';
            menu.classList.add('show');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('show');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu')) hideContextMenu();
        });

        function showLibraryContextMenu(e) {
            showContextMenu(e, [
                { label: 'Comprar carta', action: "sendAction('draw_card'); hideContextMenu();" },
                { divider: true },
                { label: 'Ver topo (1)', action: "sendAction('look_top', {count: 1}); hideContextMenu();" },
                { label: 'Ver topo (3)', action: "sendAction('look_top', {count: 3}); hideContextMenu();" },
                { label: 'Videncia (Scry)...', action: "promptScry(); hideContextMenu();" },
                { divider: true },
                { label: 'Ver toda biblioteca', action: "sendAction('view_library'); hideContextMenu();" },
                { label: 'Embaralhar', action: "sendAction('shuffle_library'); animateShuffle(); hideContextMenu();" },
            ]);
        }

        function showLibraryMenu() {
            showLibraryContextMenu({ clientX: window.innerWidth / 2, clientY: window.innerHeight / 2, preventDefault: () => {} });
        }

        function showHandContextMenu(e, card) {
            showContextMenu(e, [
                { label: 'Jogar no Campo', action: `moveCard('${card.id}', 'battlefield'); hideContextMenu();` },
                { divider: true },
                { label: 'Descartar', action: `moveCard('${card.id}', 'graveyard'); hideContextMenu();` },
                { label: 'Exilar', action: `moveCard('${card.id}', 'exile'); hideContextMenu();` },
                { divider: true },
                { label: 'Revelar para todos', action: `sendAction('reveal_card', {object_id: '${card.id}'}); hideContextMenu();` },
                { divider: true },
                { label: 'Devolver ao topo', action: `sendAction('put_top', {object_id: '${card.id}'}); hideContextMenu();` },
                { label: 'Devolver ao fundo', action: `sendAction('put_bottom', {object_id: '${card.id}'}); hideContextMenu();` },
            ]);
        }

        function showBattlefieldContextMenu(e, card, isMe = false) {
            const items = [];

            // Ver carta option (for all cards)
            items.push({ label: 'Ver carta', action: `showCard('${card.id}', '${card.image_normal}', '${card.name}', 'battlefield', ${isMe}); hideContextMenu();` });

            if (isMe) {
                items.push({ divider: true });
                const tapLabel = card.is_tapped ? 'Desvirar' : 'Virar';
                items.push({ label: tapLabel, action: `toggleTap('${card.id}'); hideContextMenu();` });
                if (selectedCards.size > 1) {
                    items.push({ label: `${tapLabel} Selecionadas (${selectedCards.size})`, action: `tapSelected(); hideContextMenu();` });
                }
                items.push({ divider: true });
                items.push({ label: 'Criar seta (jogador/carta)', action: `startArrowFromCard('${card.id}'); hideContextMenu();` });
                // Check if card has arrows (can have multiple)
                const cardArrows = arrows.filter(a => a.sourceCardId === card.id);
                if (cardArrows.length === 1) {
                    const idx = arrows.findIndex(a => a.sourceCardId === card.id);
                    items.push({ label: 'Remover seta', action: `removeArrow(${idx}); hideContextMenu();` });
                } else if (cardArrows.length > 1) {
                    items.push({ label: `Remover todas setas (${cardArrows.length})`, action: `removeArrowsFromCard('${card.id}'); hideContextMenu();` });
                }
                items.push({ divider: true });
                items.push({ label: 'Enviar para Cemiterio', action: `moveCard('${card.id}', 'graveyard'); hideContextMenu();` });
                items.push({ label: 'Exilar', action: `moveCard('${card.id}', 'exile'); hideContextMenu();` });
                items.push({ label: 'Devolver a Mao', action: `moveCard('${card.id}', 'hand'); hideContextMenu();` });
                if (card.is_commander) {
                    items.push({ label: 'Devolver a Zona de Comando', action: `moveCard('${card.id}', 'command'); hideContextMenu();` });
                }
                items.push({ divider: true });
                items.push({ label: 'Adicionar +1/+1', action: `addCounter('${card.id}'); hideContextMenu();` });
                items.push({ label: 'Remover +1/+1', action: `removeCounter('${card.id}'); hideContextMenu();` });
            }
            showContextMenu(e, items);
        }

        function showCommandContextMenu(e, cardId) {
            showContextMenu(e, [
                { label: 'Lancar Comandante', action: `moveCard('${cardId}', 'battlefield'); hideContextMenu();` },
                { label: 'Exilar', action: `moveCard('${cardId}', 'exile'); hideContextMenu();` },
            ]);
        }

        function tapSelected() {
            selectedCards.forEach(id => sendAction('tap_card', { object_id: id }));
            selectedCards.clear();
        }

        function promptScry() {
            const count = prompt('Quantas cartas? (1-10)', '3');
            const num = parseInt(count);
            if (num && num >= 1 && num <= 10) {
                sendAction('scry', { count: num });
            }
        }

        // ===== MODALS =====
        function showScryModal(cards, isScry = true) {
            scryCardsData = cards;
            document.getElementById('scryTitle').textContent = isScry ? 'Videncia - Escolha a ordem' : 'Cartas do topo';
            const container = document.getElementById('scryCards');
            container.innerHTML = cards.map(c => `
                <div class="card" data-id="${c.id}" draggable="true" ondragstart="handleScryDragStart(event, '${c.id}')">
                    <img src="${c.image_normal || c.image_small}" alt="${c.name}">
                </div>
            `).join('');
            document.getElementById('scryTopCards').innerHTML = '';
            document.getElementById('scryBottomCards').innerHTML = '';
            document.getElementById('scryModal').classList.add('show');
        }

        function handleScryDragStart(e, cardId) {
            e.dataTransfer.setData('text/plain', cardId);
        }

        function handleScryDrop(e, position) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const cardId = e.dataTransfer.getData('text/plain');
            const card = scryCardsData.find(c => c.id === cardId);
            if (!card) return;
            document.querySelectorAll(`[data-id="${cardId}"]`).forEach(el => el.remove());
            const targetContainer = position === 'top' ? document.getElementById('scryTopCards') : document.getElementById('scryBottomCards');
            const div = document.createElement('div');
            div.className = 'card';
            div.dataset.id = cardId;
            div.draggable = true;
            div.ondragstart = (ev) => handleScryDragStart(ev, cardId);
            div.innerHTML = `<img src="${card.image_small || card.image_normal}" alt="${card.name}">`;
            targetContainer.appendChild(div);
        }

        function confirmScry() {
            const topCards = Array.from(document.querySelectorAll('#scryTopCards .card')).map(el => ({ id: el.dataset.id, position: 'top' }));
            const bottomCards = Array.from(document.querySelectorAll('#scryBottomCards .card')).map(el => ({ id: el.dataset.id, position: 'bottom' }));
            if (topCards.length + bottomCards.length > 0) {
                sendAction('reorder_scry', { order: [...topCards, ...bottomCards] });
            }
            closeScryModal();
        }

        function closeScryModal() {
            document.getElementById('scryModal').classList.remove('show');
            scryCardsData = [];
        }

        function showZoneViewer(zoneName, seat = mySeat) {
            const zones = gameState.zones_data[seat];
            if (!zones) return;
            const cards = zones[zoneName] || [];
            const titles = { graveyard: 'Cemiterio', exile: 'Exilio', hand: 'Mao' };
            const player = gameState.players.find(p => p.seat_position === seat);
            const playerName = player ? player.nickname : '';
            document.getElementById('zoneViewerTitle').textContent = `${titles[zoneName] || zoneName} - ${playerName} (${cards.length})`;
            document.getElementById('zoneViewerCards').innerHTML = cards.map(c => `
                <div class="card" data-id="${c.id}" onclick="showCard('${c.id}', '${c.image_normal}', '${c.name}', '${zoneName}', ${seat === mySeat})">
                    <img src="${c.image_normal}" alt="${c.name}">
                </div>
            `).join('');
            document.getElementById('zoneViewerModal').classList.add('show');
        }

        function showOpponentZone(seat, zoneName) {
            showZoneViewer(zoneName, seat);
        }

        function closeZoneViewer() {
            document.getElementById('zoneViewerModal').classList.remove('show');
        }

        // Library Viewer
        let libraryViewerCards = [];

        function showLibraryViewerModal(cards) {
            libraryViewerCards = cards;
            renderLibraryViewer();
            document.getElementById('libraryViewerModal').classList.add('show');
        }

        function renderLibraryViewer() {
            document.getElementById('libraryViewerTitle').textContent = `Sua Biblioteca (${libraryViewerCards.length})`;
            document.getElementById('libraryViewerCards').innerHTML = libraryViewerCards.map(c => `
                <div class="card library-card" data-id="${c.id}"
                     onclick="showLibraryCardActions('${c.id}', '${c.image_normal}', '${c.name}')"
                     oncontextmenu="showLibraryCardContextMenu(event, '${c.id}', '${c.name}'); return false;">
                    <img src="${c.image_normal || c.image_small}" alt="${c.name}">
                </div>
            `).join('');
        }

        function showLibraryCardActions(cardId, imageUrl, cardName) {
            // Show card modal with library-specific actions
            selectedCard = { id: cardId, zone: 'library', name: cardName };
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('modalActions').innerHTML = `
                <button class="close" onclick="closeModal()">Fechar</button>
                <button class="action-btn" onclick="moveFromLibrary('${cardId}', 'hand')">Colocar na Mao</button>
                <button class="action-btn" onclick="moveFromLibrary('${cardId}', 'battlefield')">Colocar no Campo</button>
                <button class="action-btn" onclick="moveFromLibrary('${cardId}', 'graveyard')">Enviar ao Cemiterio</button>
                <button class="action-btn" onclick="moveFromLibrary('${cardId}', 'exile')">Exilar</button>
            `;
            document.getElementById('cardModal').classList.add('show');
        }

        function showLibraryCardContextMenu(e, cardId, cardName) {
            showContextMenu(e, [
                { label: 'Colocar na Mao', action: `moveFromLibrary('${cardId}', 'hand'); hideContextMenu();` },
                { label: 'Colocar no Campo', action: `moveFromLibrary('${cardId}', 'battlefield'); hideContextMenu();` },
                { divider: true },
                { label: 'Enviar ao Cemiterio', action: `moveFromLibrary('${cardId}', 'graveyard'); hideContextMenu();` },
                { label: 'Exilar', action: `moveFromLibrary('${cardId}', 'exile'); hideContextMenu();` },
                { divider: true },
                { label: 'Colocar no Topo', action: `sendAction('put_top', {object_id: '${cardId}'}); removeFromLibraryViewer('${cardId}'); hideContextMenu();` },
                { label: 'Colocar no Fundo', action: `sendAction('put_bottom', {object_id: '${cardId}'}); removeFromLibraryViewer('${cardId}'); hideContextMenu();` },
            ]);
        }

        function moveFromLibrary(cardId, zone) {
            closeModal();
            sendAction('move_card', { object_id: cardId, zone: zone });
            removeFromLibraryViewer(cardId);
        }

        function removeFromLibraryViewer(cardId) {
            libraryViewerCards = libraryViewerCards.filter(c => c.id !== cardId);
            renderLibraryViewer();
        }

        function closeLibraryViewer() {
            document.getElementById('libraryViewerModal').classList.remove('show');
            libraryViewerCards = [];
            // Auto shuffle when closing
            sendAction('shuffle_library');
            animateShuffle();
        }

        function showRevealAnimation(cardData) {
            document.getElementById('revealedCardImage').src = cardData.image_normal;
            document.getElementById('revealedCardText').textContent = `${cardData.player} revelou ${cardData.name}`;
            const overlay = document.getElementById('revealOverlay');
            overlay.classList.add('show');
            setTimeout(() => overlay.classList.remove('show'), 2500);
        }

        function animateShuffle() {
            const lib = document.getElementById('myLibrary');
            lib.classList.add('shuffling');
            setTimeout(() => lib.classList.remove('shuffling'), 500);
        }

        function showCard(objId, imageUrl, cardName, zone, isMe = false) {
            selectedCard = { id: objId, zone, name: cardName };
            document.getElementById('modalImage').src = imageUrl;

            let actions = '<button class="close" onclick="closeModal()">Fechar</button>';
            if (isMe) {
                if (zone === 'hand') {
                    actions += `
                        <button class="action-btn" onclick="moveCard('${objId}', 'battlefield')">Jogar</button>
                        <button class="action-btn" onclick="moveCard('${objId}', 'graveyard')">Descartar</button>
                        <button class="action-btn" onclick="moveCard('${objId}', 'exile')">Exilar</button>
                    `;
                } else if (zone === 'battlefield') {
                    actions += `
                        <button class="action-btn" onclick="toggleTap('${objId}')">Virar/Desvirar</button>
                        <button class="action-btn" onclick="moveCard('${objId}', 'graveyard')">Cemiterio</button>
                        <button class="action-btn" onclick="moveCard('${objId}', 'exile')">Exilar</button>
                        <button class="action-btn" onclick="moveCard('${objId}', 'hand')">Mao</button>
                        <button class="action-btn" onclick="moveCard('${objId}', 'command')">Zona Comando</button>
                        <button class="action-btn" onclick="startArrowFromCard('${objId}'); closeModal();">Criar Seta</button>
                    `;
                } else if (zone === 'command') {
                    actions += `<button class="action-btn" onclick="moveCard('${objId}', 'battlefield')">Lancar</button>`;
                } else if (zone === 'graveyard') {
                    actions += `
                        <button class="action-btn" onclick="moveCard('${objId}', 'hand')">Mao</button>
                        <button class="action-btn" onclick="moveCard('${objId}', 'battlefield')">Reanimar</button>
                        <button class="action-btn" onclick="moveCard('${objId}', 'exile')">Exilar</button>
                    `;
                } else if (zone === 'exile') {
                    actions += `
                        <button class="action-btn" onclick="moveCard('${objId}', 'hand')">Mao</button>
                        <button class="action-btn" onclick="moveCard('${objId}', 'battlefield')">Campo</button>
                    `;
                } else if (zone === 'library') {
                    actions += `
                        <button class="action-btn" onclick="moveCard('${objId}', 'hand')">Mao</button>
                        <button class="action-btn" onclick="moveCard('${objId}', 'battlefield')">Campo</button>
                        <button class="action-btn" onclick="moveCard('${objId}', 'graveyard')">Cemiterio</button>
                        <button class="action-btn" onclick="moveCard('${objId}', 'exile')">Exilar</button>
                    `;
                }
            }
            document.getElementById('modalActions').innerHTML = actions;
            document.getElementById('cardModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('cardModal').classList.remove('show');
            selectedCard = null;
        }

        // ===== GAME ACTIONS =====
        function moveCard(objId, zone, targetSeat = null) {
            closeModal();
            closeZoneViewer();
            const data = { object_id: objId, zone };
            if (targetSeat !== null) data.target_seat = targetSeat;
            sendAction('move_card', data);
        }

        function changeLife(seat, delta) {
            sendAction('change_life', { target_seat: seat, delta });
        }

        function addCounter(objId) {
            closeModal();
            sendAction('add_counter', { object_id: objId, counter_type: '+1/+1' });
        }

        function removeCounter(objId) {
            closeModal();
            sendAction('remove_counter', { object_id: objId, counter_type: '+1/+1' });
        }

        // ===== EVENT LISTENERS =====
        document.getElementById('cardModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('zoneViewerModal').addEventListener('click', function(e) {
            if (e.target === this) closeZoneViewer();
        });

        document.getElementById('libraryViewerModal').addEventListener('click', function(e) {
            if (e.target === this) closeLibraryViewer();
        });

        document.getElementById('counterModal').addEventListener('click', function(e) {
            if (e.target === this) closeCounterModal();
        });

        document.addEventListener('keydown', function(e) {
            if (e.target.matches('input, textarea')) return;
            switch(e.key.toLowerCase()) {
                case 'escape':
                    closeModal();
                    closeZoneViewer();
                    closeScryModal();
                    closeCounterModal();
                    hideContextMenu();
                    cancelArrowMode();
                    selectedCards.clear();
                    renderGame();
                    break;
                case 'd': sendAction('draw_card'); break;
                case 'n': sendAction('next_phase'); break;
                case 'p': sendAction('next_turn'); break;
                case 's': sendAction('shuffle_library'); animateShuffle(); break;
                case 'g': showZoneViewer('graveyard'); break;
                case 'e': showZoneViewer('exile'); break;
                case 'l': showLibraryMenu(); break;
                case 'c': toggleSidebar(); break;
                case 'x': clearAllArrows(); break;
            }
        });

        // Redraw arrows on resize
        window.addEventListener('resize', renderArrows);

        if (tabId) {
            document.getElementById('lobbyLink').href = `/lobby/?tab=${tabId}`;
        }

        connectWebSocket();
    </script>
</body>
</html>
